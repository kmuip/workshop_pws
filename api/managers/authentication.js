const utils=require("../stuff"),forge=require("node-forge"),MtoRsa=require("../lib/MtoRsa"),{EncryptWithPublicKey:EncryptWithPublicKey,DecryptWithPassword:DecryptWithPassword}=require("../lib/MtoEncryption"),{MtoPbkdf2:MtoPbkdf2}=require("../lib/MtoPbkdf2"),Enums=require("../psrApiEnums"),Types=require("../psrApiTypes"),{sha256:sha256}=require("../lib/MtoSha");module.exports=function(){const t=(()=>{function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()})();function e({maintenance:t,multiFactor:e,service:i},n,s,o,r){this._activeDirectoryAuth=!1,this._pbkdf2Key=null,this._authToken=null,this._authOptions=null,this._maintenanceServiceClient=t,this._multiFactorServiceClient=e,this._serviceClient=i,this._psrApi=n,this._ouManager=s,this._userKeyManager=o,this._realtimeConnection=r}const i=t=>Buffer.from(t).toString("base64"),n=()=>{const e={};return e.ClientVersion=utils.getClientVersion(),e.ClientInstanceId=t,e.ClientType=utils.getClientType(),e},s=(t,e)=>{const i=new MtoRsa;return i.privateKeyFromXml(e),i.signData(forge.util.decode64(t),!0,"utf16")},o=(t,e,i)=>{t._resultValues[e]=i},r=(t,e)=>{const n={None:0,OneTimeToken:1,NextOneTimeToken:2,Pin:4,NewPinRequired:8,CertificateThumbPrint:16,SignedDataId:32,WithServerKeyEncryptedPassword:64},s=[];s.push(i(t._guId)),s.push(t._tokenSessionId?i(t._tokenSessionId):"");const o=Object.keys(t._resultValues).filter(t=>"undefined"!==t&&"$type"!==t),r=[];for(const e of o)"None"!==e&&r.push(n[e],i(t._resultValues[e]));return s.push(r.join(",")),i((e||"")+"|"+s.join(";"))},a=async function(t,e){if(!e){const i=await this._multiFactorServiceClient.getCurrentUserRightKey();e=DecryptWithPassword(t,i)}const n=JSON.stringify(new Date).split('"').join(""),o=sha256(`${this._authToken.SessionId};${n}`),r=s(i(o),e);this._serviceClient.setTokens(this._authToken,`${r};${this._authToken.SessionId};${n}`)},h=function(t,e,h,u){return function(t,e){this._authToken=n(),this._authToken.UserName=e,this._authToken.Database=t,this._maintenanceServiceClient.setToken(this._authToken)}.bind(this)(t,e),async function(t){const e=t=>t?Buffer.from(t,"base64").toString("binary"):t,i=[this._maintenanceServiceClient.getOrganisationUnitUserSalt().then(e),this._maintenanceServiceClient.getOrganisationUnitServerPublicKey().then(e)],n=await Promise.all(i),s=n[0],o=n[1];if(!s)throw new Error("No user salt");if(o){const e=new MtoRsa,i=o;e.publicKeyFromXml(i),this._authToken.UserHash=EncryptWithPublicKey(e,t),this._activeDirectoryAuth=!0}else this._pbkdf2Key=MtoPbkdf2(t,s,1e5,32),this._authToken.UserHash=this._pbkdf2Key;this._maintenanceServiceClient.setToken(this._authToken),this._multiFactorServiceClient.setToken(this._authToken)}.bind(this)(h).then(()=>(async function(t,e){const i=await this._multiFactorServiceClient.getCurrentUserRightKey();if(!i)throw new Error("No user right key");if(this._activeDirectoryAuth)this._authToken.UserHashSign=this._authToken.UserHash;else{const e=DecryptWithPassword(t,i);this._authToken.UserHashSign=s(this._pbkdf2Key,e)}const n=await this._multiFactorServiceClient.getClientAuthOptions();this._authOptions=n;const a=this._authOptions[0];a&&e&&(e.forEach(t=>o(a,t.type,t.value)),this._authToken.AuthOptions=r(a,this._authToken.SessionID)),this._maintenanceServiceClient.setToken(this._authToken),this._multiFactorServiceClient.setToken(this._authToken),this._serviceClient.setTokens(this._authToken)}).bind(this)(h,u)).then(()=>(async function(){return this._authOptions&&0!==this._authOptions.length?Object.keys(this._authOptions[0]._resultValues).filter(t=>"$type"!==t&&"None"!==t).every(t=>!this._authOptions[0]._resultValues[t])?2:this._multiFactorServiceClient.checkAuthentication(i(JSON.stringify(this._authOptions))):1}).bind(this)()).then(t=>(async function(t,e){if(0===t)throw new Types.PsrApiException(Enums.PsrApiExceptionCode.MultiFactorAuthenticationFailed);if(1!==t)return t;const i=await this._serviceClient.openSession();if(!i)throw new Error("No session ID");return this._authToken.SessionId=i,this._maintenanceServiceClient.setToken(this._authToken),this._multiFactorServiceClient.setToken(this._authToken),this._serviceClient.setTokens(this._authToken),await a.bind(this)(e),1}).bind(this)(t,h))},u=function(){this._psrApi.sessionState=Enums.PsrSessionState.Disconnected,this._authToken=n(),this._maintenanceServiceClient.setToken(this._authToken),this._multiFactorServiceClient.setToken(this._authToken),this._serviceClient.setTokens(this._authToken),this._activeDirectoryAuth=!1,this._pbkdf2Key=null};return e.prototype.login=async function(t,e,i,n){if(this._psrApi.sessionState===Enums.PsrSessionState.Connected)throw new Types.PsrApiException(Enums.PsrApiExceptionCode.AlreadyAuthenticated);if(n||u.bind(this)(),i=forge.util.encodeUtf8(i),t=forge.util.encodeUtf8(t),e=forge.util.encodeUtf8(e),2===await h.bind(this)(t,e,i,n)){const t=this._authOptions[0];if(t._authenticatorNeedsToBeInitialized)throw new Types.PsrApiException(Enums.PsrApiExceptionCode.AuthenticatorNeedsToBeInitialized);return{id:t._guId,authenticatorType:t._authType,mandatory:t._isMandatory,displayName:t._displayName,requiredFields:Object.keys(t._resultValues).filter(t=>"None"!==t&&"$type"!==t).map(t=>({type:t,value:""})),dataToSign:t._dataToSign}}this._psrApi.sessionState=Enums.PsrSessionState.Connected;const s=await this._maintenanceServiceClient.getOrganisationUnitUserGuid(e),o=await this._ouManager.getOrganisationUnitUser(s);return this._psrApi.currentUser=o,await this._userKeyManager.initializeUserKeys(i),this._realtimeConnection.connect(this._authToken),null},e.prototype.forkSession=function(t,e,i){return this._serviceClient.forkSession(t,e,i)},e.prototype.logout=async function(){try{this._psrApi.sessionState===Enums.PsrSessionState.Connected&&await this._serviceClient.closeSession()}catch(t){}finally{u.bind(this)(),this._realtimeConnection.closeConnection()}},e.prototype.getUserKeys=function(){return this._userKeyManager.getUserKeys()},e.prototype.setSession=async function(t,e){const i=!t.hasOwnProperty("ClientInstanceId");let n,s;if(this._psrApi.sessionState===Enums.PsrSessionState.Connected&&await this.logout(),t.csrfToken&&(n=t.csrfToken,delete t.csrfToken),this._authToken=t,this._maintenanceServiceClient.setToken(t),this._multiFactorServiceClient.setToken(t),this._serviceClient.setTokens(t,n),e&&e.length&&e[0]&&await a.bind(this)(null,e[0].privateKey),this._userKeyManager.setUserKeys(e),this._psrApi.sessionState=Enums.PsrSessionState.Connected,i)s=await this._ouManager.getCurrentOrganisationUnit();else{const e=await this._maintenanceServiceClient.getOrganisationUnitUserGuid(t.UserName);s=await this._ouManager.getOrganisationUnitUser(e)}this._psrApi.currentUser=s},e.prototype.getSession=function(){return{token:this._authToken,userKeys:this.getUserKeys()}},e}();