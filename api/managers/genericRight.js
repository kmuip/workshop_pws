const forge=require("node-forge"),{PsrEntityObjectType:PsrEntityObjectType,PsrRights:PsrRights,PsrBatchRightItemType:PsrBatchRightItemType,PsrApiExceptionCode:PsrApiExceptionCode}=require("../psrApiEnums");module.exports=(()=>{const t=0,e=1,i=2,a=4,g=8,h=15;function r(t,e,i,a,g){this._psrApi=t,this._rightManager=e,this._ouManager=i,this._sealManager=a,this._userKeyManager=g}const s=t=>{t.ValidFromUtc&&("string"==typeof t.ValidFromUtc&&(t.ValidFromUtc=new Date(t.ValidFromUtc)),t.ValidFromUtc.setHours(0,0,0,0)),t.ValidToUtc&&("string"==typeof t.ValidToUtc&&(t.ValidToUtc=new Date(t.ValidToUtc)),t.ValidToUtc.setHours(23,59,59,0))},d=(h,r)=>{let s=t;r.OwnerRight!==h.OwnerRight&&(s|=e),r.Rights!==h.LegitimateRights&&(s|=i),r.SecuredData!==h.SecuredData&&(s|=a),(!h.Seal&&r.SealId||h.Seal&&r.SealId!==h.Seal.Id)&&(s|=g),h.RightPropertyUpdates=s},n=(t,e,i)=>{if(!i)return[];const a=[];return i.forEach(i=>{if(!i.LegitimateData)return;const g=e.find(t=>t.LegitimateId===i.LegitimateData.Id);g&&g.OwnerRight||a.push({ItemType:PsrBatchRightItemType.UpdateLegitimateDataRightValidDate,DataId:t.Id,LegitimateId:i.LegitimateData.Id,ValidFrom:i.ValidFrom,ValidTo:i.ValidTo})}),a},m=async function(t,e,i,a){if(!t)return;const g=[];if(g.push(R.bind(this)(t,e,a)),!i||!t.Items)return Promise.all(g);for(const i of t.Items)g.push(R.bind(this)(i,e,a,!1));await Promise.all(g)},o=async function(t,e,i,a,g,h){if(!t)return;if(t.ActiveDirectoryProfileId!==h||await this._rightManager.batchUpdateRights(await R.bind(this)(t,e,g)),!a||!i)return;const r=i.find(e=>e.OrganisationUnit.Id===t.Id);if(!r||!r.ChildrenOrganisationUnits)return;const s=[];for(const t of r.ChildrenOrganisationUnits)t.DataType()!==PsrEntityObjectType.EntityObjectTypeGroup&&s.push(o(t,e,i,!0,g,h));await Promise.all(s)},c=function(t,e,i){return e.DataType()===PsrEntityObjectType.EntityObjectTypeUser&&e.Id===t.LegitimateId?null:(t.publicKey=t.Seal?t.Seal.PublicKey:t.LegitimateData.PublicKey,t.publicKey&&(t=>t.DataType()===PsrEntityObjectType.EntityObjectTypeRole||t.DataType()===PsrEntityObjectType.EntityObjectTypeUser)(e)&&i?{ItemType:PsrBatchRightItemType.UpdateLegitimateDataRightKey,DataId:e.Id,LegitimateId:t.LegitimateId,RightKey:t.IncludeDataRightKey?this._userKeyManager.encryptDataRightKey(i,forge.util.decode64(t.publicKey)):null}:void 0)},R=async function(t,h,r,s=!0){const d=this._psrApi.currentUser.Id,m=await async function(t,e){const i=this._psrApi.currentUser.Id,a=await this._rightManager.getLegitimateDataRight(t,i,e);if(a)return a;const g=[];return this._userKeyManager.keys.forEach(e=>{g.push(this._rightManager.getLegitimateDataRight(t,e.id,PsrRights.RightRight).then(t=>{if(t)return t}))}),Promise.all(g).then(t=>t.find(t=>t))}.bind(this)(t.Id,PsrRights.RightRight);if(!m){if(r)throw new Error(PsrApiExceptionCode.RightInsufficientRight);if(!h.rightChanges.every(t=>t.LegitimateId===d&&t.RightPropertyUpdates===e&&!t.OwnerRight))throw new Error(PsrApiExceptionCode.RightInsufficientRight)}let o=this._userKeyManager.decryptDataRight(m);if(!o&&m&&m.SealId&&!(o=await this._userKeyManager.decryptDataRightWithSeal(t,m)))throw new Error(PsrApiExceptionCode.SealCurrendOrganisationUnitCantEdit);if(!o&&t.Id===d){const t=this._userKeyManager.keys.find(t=>t.id===d);t&&(o=t.privateKey)}if(r){const e=await async function(t,e,i,a){const g=e.filter(t=>(t.LegitimateRights&PsrRights.RightRight)===PsrRights.RightRight),h=i.filter(t=>t.ValidFrom&&t.ValidTo);if(!g.some(t=>!(h.filter(t=>!!t.LegitimateData).map(t=>t.LegitimateData.Id).indexOf(t.LegitimateId)>-1)))throw new Error(PsrApiExceptionCode.RightLastObjektRight);const r=await this._rightManager.removeAllLegitimateDataRights(t.Id),s=[],d=e.find(t=>t.LegitimateId===r),n=e.indexOf(d);return-1!==n&&(e.splice(n,1),e.push(d)),e.forEach(e=>{s.push({ItemType:PsrBatchRightItemType.AddLegitimateDataRight,DataId:t.Id,LegitimateId:e.LegitimateId,Rights:e.LegitimateRights});const i=c.bind(this)(e,t,a);i&&s.push(i),s.push({ItemType:PsrBatchRightItemType.UpdateLegitimateSealId,DataId:t.Id,LegitimateId:e.LegitimateId,SealId:e.Seal?e.Seal.Id:null}),s.push({ItemType:PsrBatchRightItemType.UpdateLegitimateDataRightSecuredData,DataId:t.Id,LegitimateId:e.LegitimateId,SecuredData:e.SecuredData}),s.push({ItemType:PsrBatchRightItemType.UpdateLegitimateDataRightOwnerRight,DataId:t.Id,LegitimateId:e.LegitimateId,OwnerRight:e.OwnerRight})}),d||s.push({ItemType:PsrBatchRightItemType.RemoveLegitimateDataRight,DataId:t.Id,LegitimateId:r,Rights:PsrRights.RightRead}),s}.bind(this)(t,h.rightChanges,h.validChanges,o);return n(t,h.rightChanges,h.validChanges).forEach(t=>e.push(t)),this._rightManager.batchUpdateRights(e)}{const r=await async function(t,h,r,s){let d=null;const n=this._psrApi.currentUser.Id,m=[];for(const o of h){if(!s){const e=await this._rightManager.getLegitimateDataRight(t.Id,o.LegitimateId,PsrRights.RightRead);if(e&&e.SealId){const t=await this._sealManager.getSeal(e.SealId);o.Seal=t}}if(d||o.LegitimateId!==n&&!this._userKeyManager.keys.map(t=>t.Id).some(t=>t===o.LegitimateId)||o.LegitimateRightsAdd||(o.LegitimateRights&PsrRights.RightRight)!==PsrRights.RightRight){(o.RightPropertyUpdates&i)===i&&(o.LegitimateRightsAdd?m.push({ItemType:PsrBatchRightItemType.AddLegitimateDataRight,DataId:t.Id,LegitimateId:o.LegitimateId,Rights:o.LegitimateRights}):m.push({ItemType:PsrBatchRightItemType.RemoveLegitimateDataRight,DataId:t.Id,LegitimateId:o.LegitimateId,Rights:o.LegitimateRights}));const h=c.bind(this)(o,t,r);h&&m.push(h),(o.RightPropertyUpdates&g)===g&&m.push({ItemType:PsrBatchRightItemType.UpdateLegitimateSealId,DataId:t.Id,LegitimateId:o.LegitimateId,SealId:o.Seal?o.Seal.Id:null}),(o.RightPropertyUpdates&a)===a&&m.push({ItemType:PsrBatchRightItemType.UpdateLegitimateDataRightSecuredData,DataId:t.Id,LegitimateId:o.LegitimateId,SecuredData:o.SecuredData}),(o.RightPropertyUpdates&e)===e&&m.push({ItemType:PsrBatchRightItemType.UpdateLegitimateDataRightOwnerRight,DataId:t.Id,LegitimateId:o.LegitimateId,OwnerRight:o.OwnerRight})}else d=o}if(d){const e=d;m.push({ItemType:PsrBatchRightItemType.RemoveLegitimateDataRight,DataId:t.Id,LegitimateId:e.LegitimateId,Rights:e.LegitimateRights}),m.push({ItemType:PsrBatchRightItemType.UpdateLegitimateDataRightOwnerRight,DataId:t.Id,LegitimateId:e.LegitimateId,OwnerRight:e.OwnerRight})}return m}.bind(this)(t,h.rightChanges,o,s);return n(t,h.rightChanges,h.validChanges).forEach(t=>r.push(t)),this._rightManager.batchUpdateRights(r)}},p=async function(t,e,i,a){const g=[],h=!i&&t.some(t=>t.DataType()===PsrEntityObjectType.EntityObjectTypeGroup)?await this._ouManager.getOrganisationUnitStructure({}):null;for(const r of t)-1===[1,2,3].indexOf(r.DataType())?r.DataType()!==PsrEntityObjectType.EntityObjectTypeGroup?g.push(R.bind(this)(r,e,a)):g.push(o.bind(this)(r,e,h,i,a,r.ActiveDirectoryProfileId)):g.push(m.bind(this)(r,e,i,a));await Promise.all(g)},I=async function(t,e){const a=[],g=[],r=(await this._rightManager.getLegitimateDataRightsWithTemporalRights(t,new Date("0001-01-01T00:00:00Z"),new Date("9999-12-31T23:59:59Z"))).map(t=>({DataRight:t,IncludeDataRightKey:!!t.RightKey}));for(const t of e){const e=r.find(e=>e.DataRight.LegitimateId===t.LegitimateId);if(e){const h=t.Rights&~e.DataRight.Rights,r=e.DataRight.Rights&~t.Rights;if((h>0||r>0)&&a.push({LegitimateData:t.Legitimate,LegitimateId:t.LegitimateId,LegitimateRights:h>0?h:r,IncludeDataRightKey:t.IncludeDataRightKey,Seal:t.Seal,OwnerRight:t.OwnerRight,SecuredData:t.SecuredData,LegitimateRightsAdd:h>0,RightPropertyUpdates:i}),t.IncludeDataRightKey!==e.IncludeDataRightKey||t.OwnerRight!==e.DataRight.OwnerRight||t.SecuredData!==e.DataRight.SecuredData||t.SealId!==e.DataRight.SealId){const i={LegitimateData:t.Legitimate,LegitimateId:t.LegitimateId,LegitimateRights:t.Rights,IncludeDataRightKey:t.IncludeDataRightKey,Seal:t.Seal,OwnerRight:t.OwnerRight,SecuredData:t.SecuredData,LegitimateRightsAdd:!0};a.push(i),d(i,e.DataRight)}t.ValidFromUtc===e.DataRight.ValidFromUtc&&t.ValidToUtc===e.DataRight.ValidToUtc||(s(t),g.push({LegitimateData:t.Legitimate,ValidFrom:t.ValidFromUtc,ValidTo:t.ValidToUtc}))}else{if(t.Rights<=0)continue;const e={LegitimateData:t.Legitimate,LegitimateId:t.LegitimateId,LegitimateRights:t.Rights,IncludeDataRightKey:t.IncludeDataRightKey,Seal:t.Seal,OwnerRight:t.OwnerRight,SecuredData:t.SecuredData,LegitimateRightsAdd:!0,RightPropertyUpdates:h};a.push(e),s(e),a.push({LegitimateData:t.Legitimate,LegitimateId:t.Legitimate.Id,ValidFrom:t.ValidFromUtc,ValidTo:t.ValidToUtc})}}for(const t of r){const g=t.DataRight.LegitimateId,h=t.DataRight.Rights;e.find(t=>t.LegitimateId===g)||(t.DataRight.Rights<=0||a.push({LegitimateData:t.DataRight.Legitimate,LegitimateId:g,LegitimateRights:h,LegitimateRightsAdd:!1,RightPropertyUpdates:i}))}return{rightChanges:a,validChanges:g}};return r.prototype.saveRights=async function(t,e,i,a){if(t&&t.length)if(a)await p.bind(this)(t,(t=>{const e=[],i=[];for(const a of t.filter(t=>t.Rights>0))e.push({LegitimateData:a.Legitimate,LegitimateId:a.LegitimateId,LegitimateRights:a.Rights,IncludeDataRightKey:a.IncludeDataRightKey,OwnerRight:a.OwnerRight,SecuredData:a.SecuredData,Seal:a.Seal,LegitimateRightsAdd:!0}),s(a),i.push({LegitimateData:a.Legitimate,ValidFrom:a.ValidFromUtc,ValidTo:a.ValidToUtc});return{rightChanges:e,validChanges:i}})(e),i,!0);else for(const a of t){const t=await I.bind(this)(a.Id,e);await p.bind(this)([a],t,i,!1)}},r})();