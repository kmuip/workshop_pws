const utils=require("../stuff"),types=require("../psrApiTypes"),{PsrEntityObjectType:PsrEntityObjectType,PsrBatchRightItemType:PsrBatchRightItemType,PsrContainerType:PsrContainerType,PsrDataStates:PsrDataStates,PsrContainerItemType:PsrContainerItemType,PsrApiExceptionCode:PsrApiExceptionCode}=require("../psrApiEnums");module.exports=(()=>{function t({maintenance:t,multiFactor:e,service:n},i,r,a,o,s,c){this._serviceClient=n,this._passwordManager=i,this._inheritanceManager=r,this._rightManager=a,this._userKeyManager=o,this._genericRightManager=s,this._oneTimePasswordManager=c}const e=function(t){(t=>{if(t)for(let e=0;e<t.length;e++)t[e].Position=e})(t);const e=t.filter(t=>t.IsEncrypted()&&null!=t.PlainTextValue),i=e.map(t=>({itemName:t.Name,privateKey:{}}));for(const t of e){n.bind(this)(t),t.Quality=this._passwordManager.getPasswordStrength(t.PlainTextValue);const e=this._userKeyManager.encryptContainerItem(t,t.PlainTextValue);i.find(e=>e.itemName===t.Name).privateKey=e}return i},n=function(t){if(t.ContainerItemType===PsrContainerItemType.ContainerItemOtp&&t.PlainTextValue)try{this._oneTimePasswordManager.generateGoogleAuthenticatorOtp(t.PlainTextValue)}catch(t){throw new Error(PsrApiExceptionCode.ContainerItemOtpMustBeBase32Encoded)}},i=function(t,e){const n=[],i=[];return t.Items.filter(t=>t.IsEncrypted()).forEach(t=>{const r=e.find(e=>e.itemName===t.Name&&e.privateKey);if(!r)return;const a=this._userKeyManager.encryptRightKeysAndReturn(t,r.privateKey).then(t=>{t.forEach(t=>{const e={ItemType:PsrBatchRightItemType.UpdateLegitimateDataRightKey,DataId:t.dataId,LegitimateId:t.legitimateId,RightKey:t.key};n.push(e)})});i.push(a)}),Promise.all(i).then(()=>n)};t.prototype.getContainerListFilter=function(t,e){return this._serviceClient.getContainerListFilter(t,e)},t.prototype.getContainerList=function(t,e,n){return this._serviceClient.getContainerList(t,e,n)},t.prototype.getContainerCount=function(t,e){return this._serviceClient.getContainerCount(t,e)},t.prototype.getContainer=function(t){return this._serviceClient.getContainer(t)},t.prototype.updateContainer=async function(t,n){t.DataTags=[],t.TimeStampUtc=(new Date).toUTCString();let r=[],a=t.Items.filter(t=>!t.Id||t.Id===utils.guidEmpty);a.forEach(t=>t.DataStates=PsrDataStates.StateActive),t.ContainerType===PsrContainerType.Password&&(r=e.bind(this)(t.Items));const o=await this._serviceClient.updateContainer(t,n);if(t.Items.forEach(t=>t.Id=o.Items.find(e=>e.Name===t.Name).Id),a.length){a.forEach(t=>t.Id=o.Items.find(e=>e.Name===t.Name).Id);const e=await this._rightManager.getLegitimateDataRights(t.Id);await this._genericRightManager.saveRights(a,e,!1,!1)}if(t.ContainerType===PsrContainerType.Password){const t=await i.bind(this)(o,r);await this._rightManager.batchUpdateRights(t)}return o},t.prototype.addContainer=async function(t,n,r,a){if(t.ContainerType===PsrContainerType.Password&&!n)throw new Error("Containers of type password must have a parent organisation unit.");t.DataTags=[];for(const e of t.Items.filter(t=>t.IsEncrypted()&&!t.PlainTextValue))e.PlainTextValue="";let o=[];t.ContainerType===PsrContainerType.Password&&(o=e.bind(this)(t.Items));const s=await this._serviceClient.addContainer(t,n);if(t.ContainerType===PsrContainerType.Password){const t=await i.bind(this)(s,o);await this._rightManager.batchUpdateRights(t),await function(t,e,n,i,r){if(e!==utils.guidEmpty)return this._inheritanceManager.run(t,n,async e=>{const n=t.Items.find(t=>t.Id===e);if(!n)return Promise.resolve([]);const r=i.find(t=>t.itemName===n.Name);if(!r)return Promise.resolve([]);const a=[];return(await this._userKeyManager.encryptRightKeysAndReturn(n,r.privateKey)).forEach(t=>{const e={ItemType:PsrBatchRightItemType.UpdateLegitimateDataRightKey,DataId:t.dataId,LegitimateId:t.legitimateId,RightKey:t.key};a.push(e)}),a},e,r,PsrEntityObjectType.EntityObjectTypePassword,t.BaseContainerId)}.bind(this)(s,n,r,o,a)}return s},t.prototype.initContainerItem=function(t){return this._serviceClient.initContainerItem(t)},t.prototype.deleteContainer=function(t){return this._serviceClient.deleteContainer(t)},t.prototype.getContainerItemWithSecretValue=function(t,e){return this._serviceClient.getContainerItemWithSecretValue(t,e)},t.prototype.getContainerItem=function(t){return this._serviceClient.getContainerItem(t)},t.prototype.getContainerInvolvedOrganisationUnit=function(t){return this._serviceClient.getContainerInvolvedOrganisationUnit(t)},t.prototype.getContainerHistoryList=function(t,e){return this._serviceClient.getContainerHistoryList(t,e)},t.prototype.cloneContainer=function(t){return this._serviceClient.cloneContainer(t)},t.prototype.initContainer=function(t){return this._serviceClient.initContainer(t)},t.prototype.getContainerBrowserSsoList=function(t){return this._serviceClient.getContainerBrowserSsoList(t)},t.prototype.getCredentialCheck=function(t){return this._serviceClient.getCredentialCheck(t)};const r=t=>{const e=new types.PsrContainerItem;return e.Name=t.Name,e.Description=t.Description,e.ContainerItemDescHighlightType=t.ContainerItemDescHighlightType,e.AllowedChars=t.AllowedChars,e.AllowOnlyGeneratedPasswords=t.AllowOnlyGeneratedPasswords,e.BaseContainerItemId=t.Id,e.ChangedOrganisationUnitId=t.ChangedOrganisationUnitId,e.CheckPolicy=t.CheckPolicy,e.ContainerId=t.ContainerId,e.ContainerItemType=t.ContainerItemType,e.DataStates=t.DataStates,e.Id=utils.guidEmpty,e.Mandatory=t.Mandatory,e.MaxLength=t.MaxLength,e.MinLength=t.MinLength,e.PolicyId=t.PolicyId,e.Position=t.Position,e.PublicKey=t.PublicKey,e.Regex=t.Regex,e.TimeStampUtc=t.TimeStampUtc,e.Quality=t.Quality,e.SecretValueRequiredReason=t.SecretValueRequiredReason,e.NoPermission=t.NoPermission,e.Value=t.Value,e.ValueBool=t.ValueBool,e.ValueDateUtc=t.ValueDateUtc,e.ValueDecimal=t.ValueDecimal,e.ValueInt=t.ValueInt,t.ListItems&&(e.ListItems=t.ListItems.slice()),e.IsEncrypted()&&(e.Value=null),e};return t.prototype.createContainerFromBaseContainer=((t,e)=>{const n=new types.PsrContainer;n.Items=[],n.ContainerType=e,n.BaseContainerId=t.Id;for(const e of t.Items)n.Items.push(r(e));return n}),t.prototype.decryptContainerItem=function(t,e){return this._userKeyManager.decryptContainerItem(t,e)},t.prototype.encryptContainerItem=function(t,e){return this._userKeyManager.encryptContainerItem(t,e)},t})();