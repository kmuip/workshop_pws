const{PasswordGeneratorSeparator:PasswordGeneratorSeparator,PsrApiExceptionCode:PsrApiExceptionCode}=require("../psrApiEnums"),_=require("lodash");module.exports=(()=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",r="abcdefghijklmnopqrstuvwxyz";function t(){}const o=e=>{if(!e)return 0;const r=[];for(let e=0;e<65535;e++)r[e]=0;let t=0;if(0===e.length)return t;for(let t=0;t<e.length;t++){let o=e[t];o<0&&(o=r.length+o),r[o]=r[o]+1}for(let o=0;o<65535;o++){if(0===r[o])continue;const s=r[o]/e.length;t-=s*(Math.log(s)/Math.log(2))}return t},s=e=>{if(!e)return 0;let r=o((e=>{const r=[],t=Buffer.from(e,"utf8");for(let e=0;e<t.length;e++)r.push(t[e]);return r.slice()})(e));if(Math.abs(r)>0){r*=Math.log(e.length)/Math.log(16);let t=(e=>{if(!e)return 0;const r=e.length;if(r<=1)return 0;const t=[];for(let o=0;o<r;o++){t[o]=e.charCodeAt(o);const r="^1234567890ß´qwertzuiopü+asdfghjklöä#<yxcvbnm,.-°!\"§$%&/()=?`QWERTZUIOPÜ*ASDFGHJKLÖÄ''>YXCVBNM;:_".indexOf(e[o]);r>0&&(t[o]=r)}for(let e=1;e<r;e++)t[e-1]=t[e-1]-t[e];return o(t.slice(0,t.length-1))})(e)+(e=>{if(!e)return 0;const r=e.length;if(r<=1)return 0;const t=[];for(let e=0;e<r-1;e++)t[e]=0;for(let o=1;o<r;o++)t[o-1]=e.charCodeAt(o-1)-e.charCodeAt(o);return o(t.slice(0,t.length))})(e);Math.abs(t)>0&&(t/=32),(r*=t)<0&&(r=-r),r>1&&(r=1)}return 100*r},n=e=>e?e.charAt(Math.floor(Math.random()*e.length)):"",a=e=>e!==PasswordGeneratorSeparator.None&&e!==PasswordGeneratorSeparator.UpperCaseLetter?1:0,i=(e,r)=>{let t;return t=n(r?e?"bdfghjklmnprstwz865":"bdfghjklmnprstwz":e?"aeiou1304":"aeiou")},l=e=>{switch(e){case PasswordGeneratorSeparator.Hyphen:return"-";case PasswordGeneratorSeparator.Space:return" ";case PasswordGeneratorSeparator.Underscore:return"_";default:return""}};return t.prototype.getPasswordStrength=function(e){return(e=>{if(e>=0){if(e<2147483647.5){let r=Math.floor(e);const t=e-r;return(t>.5||.5===t&&0!=(1&r))&&++r,r}}else if(e>=-2147483648.5){let r=Math.floor(e);const t=e-r;return(t<-.5||-.5===t&&0!=(1&r))&&--r,r}throw new Error("int32 overflow")})(s(e))},t.prototype.validatePassword=function(t,o,s=[]){if(!t)return{errors:[],missingCategoryCount:0};const n=[];let a=[],i=0,l=0;if(t.PasswordLenght>o.length&&n.push(PsrApiExceptionCode.PolicyPasswordLengthTooShort),!t)return{errors:n,missingCategoryCount:l};if(o||(o=""),t.LowerCase){_.difference(Array.from(r),Array.from(o)).length!==r.length?i++:a.push(PsrApiExceptionCode.PolicyLowerCaseRequired)}if(t.UpperCase){_.difference(Array.from(e),Array.from(o)).length!==e.length?i++:a.push(PsrApiExceptionCode.PolicyUpperCaseRequired)}if(t.Numbers){_.difference(Array.from("0123456789"),Array.from(o)).length!=="0123456789".length?i++:a.push(PsrApiExceptionCode.PolicyNumbersRequired)}if(t.SpecialChars){t.SpecialCharList||(t.SpecialCharList=""),_.difference(Array.from(t.SpecialCharList),Array.from(o)).length!==t.SpecialCharList.length?i++:a.push(PsrApiExceptionCode.PolicySpecialCharsRequired)}if(0!==t.RequiredCategories&&i>=t.RequiredCategories&&(a=[]),t.RequiredCategories>0){const e=t.RequiredCategories-i;l=e,e>0&&(1===e?a.unshift(PsrApiExceptionCode.PolicyRemainingCategoryRequired):a.unshift(PsrApiExceptionCode.PolicyRemainingCategoriesRequired))}if(t.NotAllowedPasswordUsername&&s&&0!==s.length){!(s=s.filter(e=>e)).some(e=>-1!==o.indexOf(e))||n.push(PsrApiExceptionCode.PolicyNotAllowedPasswordUserName)}if(!t.SimilarChars){_.difference(Array.from("iIl1O0"),Array.from(o)).length==="iIl1O0".length||n.push(PsrApiExceptionCode.PolicySimilarCharsNotAllowed)}if(t.NotAllowedChars){_.difference(Array.from(t.NotAllowedChars),Array.from(o)).length===t.NotAllowedChars.length||n.push(PsrApiExceptionCode.PolicyNotAllowedChars)}if(t.NotAllowedPasswords){const e=t.NotAllowedPasswords.split("\r\n");if(0!==e.length){!e.some(e=>e===o)||n.push(PsrApiExceptionCode.PolicyNotAllowedPassword)}}this.getPasswordStrength(o)<t.MinimumPasswordQuality&&n.push(PsrApiExceptionCode.PolicyMinimumPasswordQualityNotExceeded);const h=_.concat(a,n);return{errors:h,isValid:0===h.length&&0===l,missingCategoryCount:l}},t.prototype.generatePhoneticPassword=function(e,r,t=PasswordGeneratorSeparator.None,o=!1){let s="";const n=Math.floor(e/r);let h=0,f=0;for(;s.length<e;){let r="";for(;r.length<n&&s.length+r.length+a(t)<e;)r+=i(o,h%2==0),h++;t===PasswordGeneratorSeparator.None?s+=r:t===PasswordGeneratorSeparator.UpperCaseLetter?s+=r[0].toUpperCase()+r.substr(1,r.length-1):s+=(0===f?"":l(t))+r,f++}return s},t.prototype.generatePolicyPassword=function(t,o=[]){if(!t)return"";let s=[];t.Numbers&&s.push("0123456789"),t.UpperCase&&s.push(e),t.LowerCase&&s.push(r),t.SpecialChars&&s.push(t.SpecialCharList),s.forEach((e,r)=>{t.NotAllowedChars&&t.NotAllowedChars.length&&(s[r]=_.difference(Array.from(s[r]),Array.from(t.NotAllowedChars)).join("")),t.SimilarChars||(s[r]=_.difference(Array.from(s[r]),Array.from("iIl1O0")).join(""))});let a="";if(0===(s=s.filter(e=>e.length>0)).length)return a;const i=s.length;let l=0;for(let e=0;e<100;e++){for(let e=0;e<t.PasswordLenght;e++){const e=s[Math.floor(Math.random()*s.length)];a+=n(e),l=l<i-1?l+1:0}if(0===this.validatePassword(t,a,o).errors.length)break;a=""}return a},t})();